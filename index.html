<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>모두의 감사 일기장 (Firebase)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Icon Library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #FFFBF5; }
        .font-handwriting { font-family: 'Gaegu', cursive; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #fde8d3; }
        ::-webkit-scrollbar-thumb { background: #f59e0b; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #d97706; }
        .modal-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .delete-user-btn { opacity: 0; transition: opacity 0.2s ease-in-out; }
        .user-tab:hover .delete-user-btn { opacity: 1; }
        input[type="file"] { display: none; }
        .custom-file-upload {
            border: 1px solid #d1d5db; display: inline-block; padding: 6px 12px;
            cursor: pointer; background-color: #f9fafb; border-radius: 0.5rem;
            font-weight: 500; color: #374151; transition: background-color 0.2s;
        }
        .custom-file-upload:hover { background-color: #f3f4f6; }
        .new-badge {
            position: absolute;
            top: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 8px;
            background-color: #ef4444;
            border-radius: 50%;
            border: 1.5px solid white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .entry-content-clickable { cursor: pointer; }
        .editable-div {
            min-height: 10rem; border: 1px solid #d1d5db; border-radius: 0.5rem;
            padding: 0.5rem 1rem; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); transition: all 0.3s;
        }
        .editable-div:focus {
            outline: none; --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
            --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);
            box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
            border-color: #f59e0b; --tw-ring-color: rgb(245 158 11 / 0.5);
        }
        .editable-div:empty::before { content: "오늘 어떤 감사한 일이 있었나요?"; color: #9ca3af; cursor: text; }
        .editable-div img, .entry-content img { max-width: 100%; border-radius: 0.5rem; margin: 0.5rem 0; }
        
        .resizable-wrapper { position: relative; display: inline-block; line-height: 0; }
        .resizable-wrapper.active { outline: 2px solid #3b82f6; }
        .resize-handle {
            position: absolute; width: 12px; height: 12px;
            background-color: #3b82f6; border: 2px solid white;
            border-radius: 50%; z-index: 10;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .resize-handle.br { bottom: -6px; right: -6px; cursor: se-resize; }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #f59e0b;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite;
            position: absolute; top: 50%; left: 50%;
            margin-left: -20px; margin-top: -20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .heart-btn .fa-heart { transition: color 0.3s ease, transform 0.3s ease; }
        .heart-btn.liked .fa-heart { color: #ef4444; animation: heartBeat 0.5s ease; }
        @keyframes heartBeat {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="text-gray-800 flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-2xl mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-8 relative">
        <div id="loading-overlay" class="absolute inset-0 bg-white bg-opacity-75 z-50 flex items-center justify-center rounded-2xl">
            <div class="loader"></div>
        </div>
        
        <div class="mb-6">
            <div id="user-tabs-container" class="flex items-center space-x-2 border-b-2 border-amber-100 pb-2 overflow-x-auto"></div>
        </div>

        <header id="main-header" class="mb-6 text-center">
            <h1 id="main-title" class="text-4xl md:text-5xl font-bold text-amber-600 font-handwriting"></h1>
            <p id="main-subtitle" class="text-gray-500 mt-2">감사했던 일들을 기록하세요.</p>
        </header>

        <div id="quote-container" class="mb-8 text-center bg-amber-50 border-l-4 border-amber-400 p-4 rounded-r-lg">
            <p id="gratitude-quote" class="text-gray-700 italic"></p>
            <button id="new-quote-btn" class="text-xs text-amber-600 hover:text-amber-800 mt-2 font-semibold">다른 문구 보기</button>
        </div>

        <form id="journal-form" class="mb-8 space-y-4">
            <div>
                <label for="journal-date" class="block text-sm font-medium text-gray-700 mb-1">날짜</label>
                <input type="date" id="journal-date" class="w-full px-4 py-2 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-amber-500" required>
            </div>
            <div>
                <div class="flex justify-between items-center mb-1">
                    <label for="journal-entry" class="block text-sm font-medium text-gray-700">감사한 내용</label>
                    <p id="days-counter" class="text-amber-800 text-xs font-semibold bg-amber-100 rounded-full px-2 py-0.5" style="display: none;"></p>
                </div>
                <div id="journal-entry" contenteditable="true" class="editable-div"></div>
                 <div id="emoticon-bar" class="mt-2 flex flex-wrap justify-center gap-3 items-center p-2 bg-gray-50 rounded-lg">
                    <!-- Emoticons will be added here by JS -->
                </div>
            </div>
            <div>
                <label for="journal-photo" class="custom-file-upload"><i class="fa-solid fa-camera mr-2"></i>사진 추가하기</label>
                <input type="file" id="journal-photo" accept="image/*">
            </div>
            <button type="submit" class="w-full bg-amber-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-amber-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 transition-all duration-300 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">기록하기</button>
        </form>

        <div>
            <h2 id="entries-title" class="text-3xl font-semibold text-gray-800 border-b-2 border-amber-200 pb-2 mb-4 font-handwriting">나의 기록들</h2>
            <div id="entries-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                <p id="empty-message" class="text-center text-gray-500 py-4">아직 작성된 일기가 없어요.</p>
            </div>
        </div>
    </div>

    <div id="modal-container"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, getDocs, writeBatch, runTransaction, serverTimestamp, orderBy, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- 전역 변수 및 상수 ---
        const gratitudeQuotes = [ "감사하는 마음은 최고의 미덕일 뿐만 아니라, 모든 미덕의 아버지이다.", "세상에서 가장 즐거운 일은 감사하는 마음으로 사는 것이다.", "감사는 마음의 기억이다.", "작은 것에 감사할 때, 우리는 더 많은 것을 받을 준비가 된다.", "매일 아침 눈을 뜰 때마다 살아있음에 감사하라.", "감사할 줄 아는 사람에게는 부족함이 없다.", "행복은 감사의 문으로 들어온다.", "감사는 평범한 날을 추수감사절로 바꾼다.", "숨 쉴 수 있음에 감사하고, 살아 있음에 감사하라.", "감사하는 마음은 영혼을 위한 최고의 휴식이다.", "세상에서 가장 아름다운 기도는 '감사합니다'이다.", "햇살 한 줌, 바람 한 점에도 감사할 이유가 있다.", "당연하게 여겼던 모든 것들이 사실은 기적이었다.", "감사는 행복으로 가는 가장 빠른 길이다.", "오늘 내가 받은 모든 것에 감사한다.", "작은 기쁨들이 모여 큰 행복을 만든다.", "매일이 선물이라는 것을 기억하라.", "감사할수록 감사할 일이 더 많이 생긴다.", "감사는 과거를 이해하게 하고, 현재에 평화를 가져오며, 미래에 대한 비전을 창조한다.", "가장 큰 축복은 보이지 않는 곳에 있다.", "오늘 하루도 무사히 보냈음에 감사한다.", "건강한 몸과 마음을 주셔서 감사합니다.", "맛있는 음식을 먹을 수 있음에 감사합니다.", "따뜻한 집이 있다는 것에 감사합니다.", "나를 사랑해주는 사람들이 곁에 있어 감사합니다.", "배울 수 있는 기회가 있음에 감사합니다.", "아침에 눈을 뜰 수 있다는 사실에 감사합니다.", "실수로부터 배울 수 있음에 감사합니다.", "아름다운 음악을 들을 수 있음에 감사합니다.", "맑은 공기를 마실 수 있음에 감사합니다.", "오늘의 날씨에 감사합니다.", "나 자신으로 살아갈 수 있음에 감사합니다.", "웃을 수 있는 순간들에 감사합니다.", "힘들 때 기댈 수 있는 친구가 있어 감사합니다.", "새로운 하루를 시작할 힘을 주셔서 감사합니다.", "좋은 책을 읽을 수 있는 시간에 감사합니다.", "나를 성장시키는 모든 경험에 감사합니다.", "평화로운 순간들에 감사합니다.", "따뜻한 차 한잔의 여유에 감사합니다.", "나의 꿈을 응원해주는 사람들이 있어 감사합니다.", "오늘 하루 동안 만난 모든 인연에 감사합니다.", "깨끗한 물을 마실 수 있음에 감사합니다.", "편안한 잠자리에 감사합니다.", "자연의 아름다움을 느낄 수 있음에 감사합니다.", "나의 노력을 알아주는 사람이 있음에 감사합니다.", "용서할 수 있는 마음에 감사합니다.", "사랑을 주고받을 수 있음에 감사합니다.", "오늘 흘린 땀방울에 감사합니다.", "나를 믿어주는 마음에 감사합니다.", "작은 친절을 베풀 수 있는 기회에 감사합니다.", "넘어져도 다시 일어설 수 있는 용기에 감사합니다.", "함께 웃고 떠들 수 있는 동료가 있어 감사합니다.", "오늘 하루도 수고한 나 자신에게 감사합니다.", "새로운 것을 배울 수 있는 호기심에 감사합니다.", "어려움을 극복할 수 있는 지혜에 감사합니다.", "나를 필요로 하는 곳이 있음에 감사합니다.", "따뜻한 햇살 아래 산책할 수 있음에 감사합니다.", "가족들의 건강에 감사합니다.", "오늘의 소소한 행복에 감사합니다.", "나를 웃게 만드는 모든 것에 감사합니다.", "고요한 아침 시간에 감사합니다.", "편안하게 쉴 수 있는 주말에 감사합니다.", "목표를 향해 나아갈 수 있음에 감사합니다.", "나의 감정을 솔직하게 표현할 수 있음에 감사합니다.", "도움이 필요할 때 손 내밀어주는 사람들에게 감사합니다.", "아름다운 노을을 볼 수 있음에 감사합니다.", "포기하지 않는 나의 끈기에 감사합니다.", "좋은 영화 한 편 볼 수 있는 여유에 감사합니다.", "나의 부족함을 채워주는 사람들에게 감사합니다.", "오늘 하루도 최선을 다한 나에게 감사합니다.", "편안한 신발을 신고 걸을 수 있음에 감사합니다.", "밤하늘의 별을 볼 수 있음에 감사합니다.", "시원한 바람을 느낄 수 있음에 감사합니다.", "나를 응원하는 댓글 하나에 감사합니다.", "어제의 나보다 성장한 오늘의 나에게 감사합니다.", "창밖에 내리는 빗소리에 감사합니다.", "나의 이야기를 들어주는 사람이 있음에 감사합니다.", "건강하게 일할 수 있는 직장이 있음에 감사합니다.", "새로운 아이디어가 떠오른 순간에 감사합니다.", "나를 둘러싼 모든 것들의 조화에 감사합니다.", "어려운 문제를 해결했을 때의 성취감에 감사합니다.", "나를 있는 그대로 받아들여 주는 사람들에게 감사합니다.", "오늘도 무언가를 해냈다는 사실에 감사합니다.", "달콤한 간식을 먹을 수 있는 즐거움에 감사합니다.", "좋은 향기를 맡을 수 있음에 감사합니다.", "나의 작은 노력이 누군가에게 도움이 되었을 때 감사합니다.", "세상의 모든 지식에 접근할 수 있음에 감사합니다.", "힘든 하루 끝에 마시는 시원한 물 한 잔에 감사합니다.", "나의 선택을 존중해주는 사람들에게 감사합니다.", "오늘 하루 동안 느낀 모든 감정에 감사합니다.", "아무것도 하지 않고 쉴 수 있는 시간에 감사합니다.", "나의 재능을 나눌 수 있음에 감사합니다.", "세상은 여전히 아름답다는 것을 느낄 때 감사합니다.", "실패는 성공의 어머니임을 알게 해주셔서 감사합니다.", "오늘 하루도 살아있음에 감사합니다." ];

        let db, auth, storage;
        let appState = { users: {}, activeView: null, primaryUser: null, entries: [] };
        let metadataUnsubscribe = null;
        let entriesUnsubscribe = null;
        let commentsUnsubscribe = null;
        let savedRange = null;
        let unlockedUsers = new Set(); // 비밀번호 해제한 사용자 저장

        document.addEventListener('DOMContentLoaded', () => {
            const journalForm = document.getElementById('journal-form');
            const journalDate = document.getElementById('journal-date');
            const journalEntry = document.getElementById('journal-entry');
            const journalPhoto = document.getElementById('journal-photo');
            const entriesList = document.getElementById('entries-list');
            const emptyMessage = document.getElementById('empty-message');
            const quoteElement = document.getElementById('gratitude-quote');
            const newQuoteBtn = document.getElementById('new-quote-btn');
            const userTabsContainer = document.getElementById('user-tabs-container');
            const mainHeader = document.getElementById('main-header');
            const mainTitle = document.getElementById('main-title');
            const mainSubtitle = document.getElementById('main-subtitle');
            const entriesTitle = document.getElementById('entries-title');
            const modalContainer = document.getElementById('modal-container');
            const loadingOverlay = document.getElementById('loading-overlay');
            const quoteContainer = document.getElementById('quote-container');
            const daysCounter = document.getElementById('days-counter');

            const setToday = () => {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                journalDate.value = `${year}-${month}-${day}`;
            };
            setToday();

            // --- Firebase 초기화 및 인증 ---
            async function initializeFirebase() {
                const firebaseConfig = { apiKey: "AIzaSyDIKlFzyguBn9p4iQzI53DGdFb79Xqcqyg", authDomain: "gam-sa-ilgi.firebaseapp.com", projectId: "gam-sa-ilgi", storageBucket: "gam-sa-ilgi.appspot.com", messagingSenderId: "459918214357", appId: "1:459918214357:web:2eff745e4a128f7d67ce5c", measurementId: "G-0JTV8VKBEJ" };
                if (!firebaseConfig.apiKey) { loadingOverlay.innerHTML = "Firebase 설정이 필요합니다."; return; }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app); auth = getAuth(app); storage = getStorage(app);
                onAuthStateChanged(auth, async (user) => {
                    if (user) { await setupListeners(); } 
                    else { try { await signInAnonymously(auth); } catch (error) { console.error("익명 로그인 실패:", error); loadingOverlay.innerHTML = "인증에 실패했습니다."; } }
                });
            }

            // --- 데이터 리스너 설정 ---
            async function setupListeners() {
                const metadataRef = doc(db, "journalApp", "metadata");
                metadataUnsubscribe = onSnapshot(metadataRef, async (docSnap) => {
                    const lastActiveView = localStorage.getItem('activeView');
                    let localPrimaryUser = localStorage.getItem('primaryUser');

                    if (docSnap.exists() && Object.keys(docSnap.data().users).length > 0) {
                        appState.users = docSnap.data().users;
                        if (!localPrimaryUser || !appState.users[localPrimaryUser]) {
                            localPrimaryUser = Object.keys(appState.users)[0];
                            localStorage.setItem('primaryUser', localPrimaryUser);
                        }
                        appState.primaryUser = localPrimaryUser;
                        appState.activeView = (lastActiveView && (lastActiveView === 'feed' || appState.users[lastActiveView])) ? lastActiveView : 'feed';
                    } else {
                        const defaultUser = '래민';
                        appState.users = { [defaultUser]: { password: null, hasNew: false } };
                        appState.activeView = defaultUser;
                        appState.primaryUser = defaultUser;
                        localStorage.setItem('primaryUser', defaultUser);
                        localStorage.setItem('activeView', defaultUser);
                        await setDoc(metadataRef, { users: appState.users });
                    }
                    if (appState.activeView !== 'feed' && appState.users[appState.activeView] && appState.users[appState.activeView].hasNew) {
                        appState.users[appState.activeView].hasNew = false;
                        await updateDoc(metadataRef, { users: appState.users });
                    }
                    renderUI();
                }, (error) => { console.error("메타데이터 감시 실패:", error); loadingOverlay.innerHTML = "데이터를 불러오는 데 실패했습니다."; });
            }
            
            function renderUI() {
                renderTabs();
                updateTitleAndForm();
                if (appState.activeView === 'feed') {
                    setupFeedListener();
                } else {
                    setupEntriesListener();
                }
            }

            function setupEntriesListener() {
                if (entriesUnsubscribe) entriesUnsubscribe();
                if (!appState.activeView || appState.activeView === 'feed') return;
                const entriesRef = collection(db, "journalApp", appState.activeView, "entries");
                const q = query(entriesRef, orderBy("date", "desc"));
                entriesUnsubscribe = onSnapshot(q, (querySnapshot) => {
                    appState.entries = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderEntries();
                    loadingOverlay.style.display = 'none';
                }, (error) => { console.error("일기 감시 실패:", error); });
            }

            function setupFeedListener() {
                if (entriesUnsubscribe) entriesUnsubscribe();
                const feedRef = collection(db, "feedEntries");
                const q = query(feedRef, orderBy("createdAt", "desc"));
                entriesUnsubscribe = onSnapshot(q, (querySnapshot) => {
                    appState.entries = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderFeedEntries();
                    loadingOverlay.style.display = 'none';
                }, (error) => { console.error("피드 감시 실패:", error); });
            }

            // --- 모달 관리 ---
            const showModal = (type, data = {}) => {
                modalContainer.innerHTML = ''; 
                let modalHtml = '';
                switch (type) {
                    case 'edit':
                        modalHtml = `<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4"><div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 w-full max-w-lg modal-fade-in"><h2 class="text-2xl font-bold mb-4">일기 수정하기</h2><div id="edit-entry-div" contenteditable="true" class="editable-div mb-4">${data.content}</div><div><label for="edit-journal-photo" class="custom-file-upload"><i class="fa-solid fa-camera mr-2"></i>사진 추가하기</label><input type="file" id="edit-journal-photo" accept="image/*"></div><div class="mt-6 flex justify-end space-x-3"><button class="modal-cancel-btn px-4 py-2 bg-gray-200 rounded-lg">취소</button><button id="save-edit-btn" class="px-4 py-2 bg-amber-500 text-white rounded-lg">저장하기</button></div></div></div>`;
                        break;
                    case 'addUser':
                        modalHtml = `<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4"><form id="add-user-form" class="bg-white rounded-2xl shadow-xl p-6 md:p-8 w-full max-w-sm modal-fade-in space-y-4"><h2 class="text-2xl font-bold">새 사용자 추가</h2><div><label>이름</label><input type="text" id="new-user-name" class="w-full px-4 py-2 border rounded-lg" required></div><div><label>비밀번호 (선택)</label><input type="password" id="new-user-password" class="w-full px-4 py-2 border rounded-lg"></div><div id="user-error-msg" class="text-red-500 text-sm h-5"></div><div class="mt-2 flex justify-end space-x-3"><button type="button" class="modal-cancel-btn px-4 py-2 bg-gray-200 rounded-lg">취소</button><button type="submit" class="px-4 py-2 bg-green-500 text-white rounded-lg">추가하기</button></div></form></div>`;
                        break;
                    case 'confirmDelete':
                        modalHtml = `<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4"><div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 w-full max-w-sm modal-fade-in text-center"><h2 class="text-xl font-bold mb-2">정말 삭제하시겠습니까?</h2><p class="text-gray-600 mb-6">${data.message}</p><div class="flex justify-center space-x-4"><button class="modal-cancel-btn px-6 py-2 bg-gray-200 rounded-lg">취소</button><button id="confirm-delete-btn" class="px-6 py-2 bg-red-500 text-white rounded-lg">삭제</button></div></div></div>`;
                        break;
                    case 'password':
                        modalHtml = `<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4"><form id="password-form" class="bg-white rounded-2xl shadow-xl p-6 md:p-8 w-full max-w-sm modal-fade-in"><h2 class="text-2xl font-bold mb-4">비밀번호 확인</h2><input type="password" id="password-input" class="w-full px-4 py-2 border rounded-lg" required><div id="password-error-msg" class="text-red-500 text-sm mt-2 h-5"></div><div class="mt-2 flex justify-end space-x-3"><button type="button" class="modal-cancel-btn px-4 py-2 bg-gray-200 rounded-lg">취소</button><button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg">확인</button></div></form></div>`;
                        break;
                    case 'viewEntry':
                        const liked = data.likedBy && data.likedBy.includes(auth.currentUser.uid);
                        modalHtml = `
                        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4" id="view-modal-backdrop">
                            <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl modal-fade-in flex flex-col max-h-[90vh]">
                                <div class="p-6 border-b">
                                    <div class="flex justify-between items-center">
                                        <h2 class="text-xl md:text-2xl font-bold">${data.author}님의 ${data.date} 일기</h2>
                                        <button class="modal-cancel-btn text-2xl text-gray-500 hover:text-gray-800">&times;</button>
                                    </div>
                                </div>
                                <div class="p-6 overflow-y-auto flex-grow">
                                    <div class="entry-content whitespace-pre-wrap">${data.content}</div>
                                </div>
                                <div class="p-6 border-t bg-gray-50 rounded-b-2xl">
                                    <div class="flex items-center justify-between mb-2">
                                        <button id="like-btn" class="heart-btn ${liked ? 'liked' : ''} text-2xl text-gray-400"><i class="fa-solid fa-heart"></i></button>
                                        <span id="like-count" class="text-sm text-gray-600">${data.likes || 0}명이 좋아합니다</span>
                                    </div>
                                    <div id="comments-section" class="space-y-2 max-h-32 overflow-y-auto mb-2"></div>
                                    <form id="comment-form" class="flex space-x-2">
                                        <input id="comment-input" type="text" class="flex-grow border rounded-lg px-3 py-2 text-sm" placeholder="익명 댓글 달기..." required>
                                        <button type="submit" class="bg-amber-500 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-amber-600">등록</button>
                                    </form>
                                </div>
                            </div>
                        </div>`;
                        break;
                }
                modalContainer.innerHTML = modalHtml;

                const closeModal = () => { if(commentsUnsubscribe) commentsUnsubscribe(); modalContainer.innerHTML = ''; };
                modalContainer.querySelectorAll('.modal-cancel-btn, #view-modal-backdrop').forEach(btn => btn.addEventListener('click', (e) => { if(e.target === e.currentTarget) closeModal(); }));

                if (data.onConfirm) modalContainer.querySelector('#confirm-delete-btn')?.addEventListener('click', () => { data.onConfirm(); closeModal(); });
                if (data.onSave) modalContainer.querySelector('#save-edit-btn')?.addEventListener('click', () => { data.onSave(modalContainer.querySelector('#edit-entry-div').innerHTML); closeModal(); });
                if (data.onPassword) {
                    const form = modalContainer.querySelector('#password-form');
                    form?.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const password = form.querySelector('#password-input').value;
                        if (appState.users[data.user].password === password) { data.onPassword(); closeModal(); } 
                        else { form.querySelector('#password-error-msg').textContent = '비밀번호가 틀렸습니다.'; }
                    });
                }
                if (type === 'addUser') {
                    modalContainer.querySelector('#add-user-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const newUser = modalContainer.querySelector('#new-user-name').value.trim();
                        const password = modalContainer.querySelector('#new-user-password').value;
                        const errorMsg = modalContainer.querySelector('#user-error-msg');
                        if (newUser && !appState.users[newUser]) {
                            const metadataRef = doc(db, "journalApp", "metadata");
                            const newUsers = { ...appState.users, [newUser]: { password: password || null, hasNew: false } };
                            await updateDoc(metadataRef, { users: newUsers });
                            appState.activeView = newUser; localStorage.setItem('activeView', newUser); closeModal();
                        } else { errorMsg.textContent = appState.users[newUser] ? '이미 존재하는 이름입니다.' : '이름을 입력해주세요.'; }
                    });
                }
                 if (type === 'edit') {
                    const editEntryDiv = modalContainer.querySelector('#edit-entry-div');
                    const editPhotoInput = modalContainer.querySelector('#edit-journal-photo');
                    let editSavedRange = null;

                    editEntryDiv.addEventListener('blur', () => {
                        const selection = window.getSelection();
                        if (selection.rangeCount > 0) {
                            editSavedRange = selection.getRangeAt(0);
                        }
                    });

                    editPhotoInput.addEventListener('change', async (e) => {
                        const file = e.target.files[0]; if (!file) return;
                        const loadingOverlay = document.getElementById('loading-overlay');
                        loadingOverlay.style.display = 'flex';
                        const userId = auth.currentUser.uid;
                        const filePath = `journalImages/${userId}/${Date.now()}-${file.name}`;
                        const storageRef = ref(storage, filePath);
                        try {
                            await uploadBytes(storageRef, file);
                            const url = await getDownloadURL(storageRef);
                            const img = document.createElement('img');
                            img.src = url;
                            editEntryDiv.focus();
                            const selection = window.getSelection();
                            if (editSavedRange) {
                                selection.removeAllRanges();
                                selection.addRange(editSavedRange);
                            }
                            if (selection.getRangeAt && selection.rangeCount) {
                                let range = selection.getRangeAt(0);
                                range.deleteContents();
                                range.insertNode(img);
                                const space = document.createTextNode("\u00A0");
                                range.insertNode(space);
                                range.setStartAfter(space);
                                range.collapse(true);
                                selection.removeAllRanges();
                                selection.addRange(range);
                            }
                        } catch (error) {
                            console.error("사진 업로드 실패:", error);
                        } finally {
                            editPhotoInput.value = '';
                            loadingOverlay.style.display = 'none';
                        }
                    });
                }
                if (type === 'viewEntry') {
                    const commentsRef = collection(db, "journalApp", data.author, "entries", data.id, "comments");
                    const q = query(commentsRef, orderBy("createdAt", "asc"));
                    commentsUnsubscribe = onSnapshot(q, (snapshot) => {
                        const commentsSection = document.getElementById('comments-section');
                        if (!commentsSection) return;
                        commentsSection.innerHTML = '';
                        snapshot.forEach(doc => {
                            const comment = doc.data();
                            const div = document.createElement('div'); div.className = "text-sm bg-gray-100 p-2 rounded-lg";
                            div.innerHTML = `<span class="font-semibold mr-2">익명</span><span>${comment.text}</span>`;
                            commentsSection.appendChild(div);
                        });
                    });
                    document.getElementById('comment-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const input = document.getElementById('comment-input');
                        if (!input.value.trim()) return;
                        await addDoc(commentsRef, { text: input.value, createdAt: serverTimestamp() });
                        input.value = '';
                    });
                    document.getElementById('like-btn').addEventListener('click', () => handleLikeClick(data.id, data.author));
                }
            };

            // --- 렌더링 함수 ---
            const renderTabs = () => {
                userTabsContainer.innerHTML = '';
                const feedTab = document.createElement('button');
                feedTab.className = `user-tab relative flex-shrink-0 px-4 py-2 text-sm font-semibold rounded-t-lg transition-colors duration-200 ${appState.activeView === 'feed' ? 'bg-amber-500 text-white' : 'text-gray-500 hover:bg-amber-100'}`;
                feedTab.textContent = '모두';
                feedTab.dataset.user = 'feed';
                userTabsContainer.appendChild(feedTab);

                Object.keys(appState.users).forEach(user => {
                    const isActive = user === appState.activeView;
                    const tab = document.createElement('button');
                    tab.className = `user-tab relative flex-shrink-0 px-4 py-2 text-sm font-semibold rounded-t-lg transition-colors duration-200 ${isActive ? 'bg-amber-500 text-white' : 'text-gray-500 hover:bg-amber-100'}`;
                    tab.textContent = user;
                    tab.dataset.user = user;
                    if (appState.users[user].hasNew) tab.innerHTML += `<span class="new-badge"></span>`;
                    if (Object.keys(appState.users).length > 0) {
                        tab.innerHTML += `<span class="delete-user-btn absolute -top-1 -right-1 text-red-500 bg-white rounded-full w-4 h-4 flex items-center justify-center text-xs"><i class="fas fa-times-circle"></i></span>`;
                    }
                    userTabsContainer.appendChild(tab);
                });
                const addUserBtn = document.createElement('button');
                addUserBtn.id = 'add-user-btn';
                addUserBtn.className = 'ml-2 px-3 py-1 bg-green-500 text-white rounded-full text-sm font-bold hover:bg-green-600 transition-transform hover:scale-110';
                addUserBtn.innerHTML = '<i class="fas fa-plus"></i>';
                userTabsContainer.appendChild(addUserBtn);
            };
            const updateTitleAndForm = () => {
                const isFeed = appState.activeView === 'feed';

                if (isFeed) {
                    mainHeader.style.display = 'block';
                    mainTitle.textContent = '모두의 감사일기';
                    mainSubtitle.textContent = '다른 사람들의 감사한 하루를 둘러보세요.';
                    entriesTitle.textContent = '모두의 기록들';
                    journalForm.style.display = 'none';
                    quoteContainer.style.display = 'none';
                    daysCounter.style.display = 'none';
                } else {
                    mainHeader.style.display = 'block';
                    mainTitle.textContent = `${appState.activeView || ''}의 감사 일기장`;
                    mainSubtitle.textContent = '감사했던 일들을 기록하세요.';
                    entriesTitle.textContent = `${appState.activeView || ''}님의 기록들`;
                    quoteContainer.style.display = 'block';
                    journalForm.style.display = 'block';
                }
            };
            const renderEntries = () => {
                entriesList.innerHTML = '';
                if (appState.entries.length === 0) {
                    entriesList.appendChild(emptyMessage);
                    emptyMessage.style.display = 'block';
                    daysCounter.style.display = 'none';
                } else {
                    daysCounter.style.display = 'block';
                    const firstEntryDateStr = appState.entries[appState.entries.length - 1].date;
                    const [year, month, day] = firstEntryDateStr.split('-').map(Number);
                    const firstDate = new Date(year, month - 1, day);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    firstDate.setHours(0,0,0,0);
                    
                    const diffTime = today.getTime() - firstDate.getTime();
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    daysCounter.innerHTML = `🧡 ${diffDays}일째 감사 기록중 🧡`;

                    emptyMessage.style.display = 'none';
                    appState.entries.forEach(entry => {
                        const entryElement = document.createElement('div');
                        entryElement.className = 'bg-amber-50 p-4 rounded-xl border border-amber-200';
                        entryElement.dataset.id = entry.id;
                        const date = new Date(entry.date);
                        const adjustedDate = new Date(date.getTime() + (date.getTimezoneOffset() * 60000));
                        const formattedDate = adjustedDate.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = entry.content;
                        const textPreview = tempDiv.textContent || tempDiv.innerText || "";
                        const liked = entry.likedBy && entry.likedBy.includes(auth.currentUser.uid);

                        entryElement.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <p class="font-semibold text-amber-800">${formattedDate}</p>
                                <div class="flex space-x-2">
                                    <button class="edit-btn text-gray-400 hover:text-green-600 text-xs font-bold py-1 px-2 rounded">수정</button>
                                    <button class="delete-btn text-gray-400 hover:text-red-500 text-xs font-bold py-1 px-2 rounded">삭제</button>
                                </div>
                            </div>
                            <div class="entry-content-clickable cursor-pointer">
                                <p class="text-gray-700 whitespace-pre-wrap truncate">${textPreview}</p>
                            </div>
                            <div class="flex items-center space-x-4 text-sm text-gray-500 mt-2 pt-2 border-t border-amber-100">
                                <button class="like-btn heart-btn ${liked ? 'liked' : ''} flex items-center space-x-1 hover:text-red-500">
                                    <i class="fa-solid fa-heart"></i> 
                                    <span>${entry.likes || 0}</span>
                                </button>
                                <button class="comment-btn flex items-center space-x-1 hover:text-blue-500">
                                    <i class="fa-regular fa-comment"></i>
                                    <span>댓글</span>
                                </button>
                            </div>`;
                        entriesList.appendChild(entryElement);
                    });
                }
            };
            const renderFeedEntries = () => {
                daysCounter.style.display = 'none';
                entriesList.innerHTML = '';
                if (appState.entries.length === 0) {
                    entriesList.appendChild(emptyMessage);
                    emptyMessage.style.display = 'block';
                } else {
                    emptyMessage.style.display = 'none';
                    appState.entries.forEach(entry => {
                        const entryElement = document.createElement('div');
                        entryElement.className = 'bg-amber-50 p-4 rounded-xl border border-amber-200';
                        entryElement.dataset.id = entry.id;
                        entryElement.dataset.author = entry.author;
                        const date = entry.createdAt.toDate();
                        const formattedDate = date.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = entry.content;
                        const textPreview = tempDiv.textContent || tempDiv.innerText || "";
                        const liked = entry.likedBy && entry.likedBy.includes(auth.currentUser.uid);

                        entryElement.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <p class="font-semibold text-amber-800">${entry.author}님의 일기</p>
                                <span class="text-xs text-gray-500">${formattedDate}</span>
                            </div>
                            <div class="entry-content-clickable cursor-pointer">
                                <p class="text-gray-700 whitespace-pre-wrap truncate">${textPreview}</p>
                            </div>
                            <div class="flex items-center space-x-4 text-sm text-gray-500 mt-2 pt-2 border-t border-amber-100">
                                <button class="like-btn heart-btn ${liked ? 'liked' : ''} flex items-center space-x-1 hover:text-red-500">
                                    <i class="fa-solid fa-heart"></i> 
                                    <span>${entry.likes || 0}</span>
                                </button>
                                <button class="comment-btn flex items-center space-x-1 hover:text-blue-500">
                                    <i class="fa-regular fa-comment"></i>
                                    <span>댓글</span>
                                </button>
                            </div>`;
                        entriesList.appendChild(entryElement);
                    });
                }
            };

            // --- 이미지 리사이즈 로직 ---
            const makeImageResizable = (img) => {
                document.querySelectorAll('.resizable-wrapper').forEach(wrapper => { wrapper.parentNode.insertBefore(wrapper.firstChild, wrapper); wrapper.parentNode.removeChild(wrapper); });
                const wrapper = document.createElement('span');
                wrapper.className = 'resizable-wrapper active'; wrapper.contentEditable = false;
                img.parentNode.insertBefore(wrapper, img); wrapper.appendChild(img);
                const handle = document.createElement('span');
                handle.className = 'resize-handle br'; wrapper.appendChild(handle);
                handle.addEventListener('mousedown', (e) => {
                    e.preventDefault(); e.stopPropagation();
                    const startX = e.clientX; const startWidth = img.offsetWidth;
                    const doDrag = (e) => { const newWidth = startWidth + (e.clientX - startX); if (newWidth > 50) img.style.width = newWidth + 'px'; };
                    const stopDrag = () => { document.documentElement.removeEventListener('mousemove', doDrag, false); document.documentElement.removeEventListener('mouseup', stopDrag, false); };
                    document.documentElement.addEventListener('mousemove', doDrag, false); document.documentElement.addEventListener('mouseup', stopDrag, false);
                });
            };
            
            // --- 좋아요 핸들러 ---
            const handleLikeClick = async (entryId, author) => {
                const entryRef = doc(db, "journalApp", author, "entries", entryId);
                const feedRef = doc(db, "feedEntries", entryId);
                try {
                    await runTransaction(db, async (transaction) => {
                        const entryDoc = await transaction.get(entryRef);
                        if (!entryDoc.exists()) throw "문서가 존재하지 않습니다!";
                        const likedBy = entryDoc.data().likedBy || [];
                        const uid = auth.currentUser.uid;
                        const newLikedBy = likedBy.includes(uid) ? likedBy.filter(id => id !== uid) : [...likedBy, uid];
                        const newLikes = newLikedBy.length;
                        transaction.update(entryRef, { likes: newLikes, likedBy: newLikedBy });
                        transaction.update(feedRef, { likes: newLikes, likedBy: newLikedBy });
                    });
                } catch (error) {
                    console.error("좋아요 처리 실패: ", error);
                }
            };

            // --- 이모티콘 설정 ---
            function setupEmoticons() {
                const emoticonBar = document.getElementById('emoticon-bar');
                const emoticons = ['😊', '🥰', '👍', '🙏', '🎉', '☀️', '❤️', '😂', '😭', '😮'];
                
                emoticonBar.innerHTML = '';
                emoticons.forEach(emo => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'text-2xl hover:scale-125 transition-transform focus:outline-none';
                    button.textContent = emo;
                    button.addEventListener('click', () => {
                        journalEntry.focus();
                        const selection = window.getSelection();
                        
                        if (savedRange) {
                            selection.removeAllRanges();
                            selection.addRange(savedRange);
                        }

                        if (selection.getRangeAt && selection.rangeCount) {
                            const range = selection.getRangeAt(0);
                            range.deleteContents();
                            const textNode = document.createTextNode(emo);
                            range.insertNode(textNode);
                            
                            const spaceNode = document.createTextNode('\u00A0');
                            range.setStartAfter(textNode);
                            range.insertNode(spaceNode);
                            range.setStartAfter(spaceNode);
                            range.collapse(true);

                            selection.removeAllRanges();
                            selection.addRange(range);
                            
                            savedRange = range;
                        }
                    });
                    emoticonBar.appendChild(button);
                });
            }


            // --- 이벤트 리스너 ---
            document.addEventListener('click', (e) => {
                const target = e.target;
                if (target.tagName === 'IMG' && target.closest('.editable-div')) { makeImageResizable(target); } 
                else if (!target.closest('.resizable-wrapper')) { document.querySelectorAll('.resizable-wrapper').forEach(wrapper => { wrapper.parentNode.insertBefore(wrapper.firstChild, wrapper); wrapper.parentNode.removeChild(wrapper); }); }
            });

            journalEntry.addEventListener('blur', () => { const selection = window.getSelection(); if (selection.rangeCount > 0) savedRange = selection.getRangeAt(0); });

            journalPhoto.addEventListener('change', async (e) => {
                const file = e.target.files[0]; if (!file) return;
                const userId = auth.currentUser.uid; const filePath = `journalImages/${userId}/${Date.now()}-${file.name}`;
                const storageRef = ref(storage, filePath);
                try {
                    loadingOverlay.style.display = 'flex';
                    await uploadBytes(storageRef, file);
                    const url = await getDownloadURL(storageRef);
                    const img = document.createElement('img'); img.src = url;
                    journalEntry.focus(); const selection = window.getSelection();
                    if (savedRange) { selection.removeAllRanges(); selection.addRange(savedRange); }
                    if (selection.getRangeAt && selection.rangeCount) {
                        let range = selection.getRangeAt(0); range.deleteContents(); range.insertNode(img);
                        const space = document.createTextNode("\u00A0"); range.insertNode(space);
                        range.setStartAfter(space); range.collapse(true);
                        selection.removeAllRanges(); selection.addRange(range);
                    }
                } catch (error) { console.error("사진 업로드 실패:", error); } 
                finally { journalPhoto.value = ''; loadingOverlay.style.display = 'none'; }
            });

            userTabsContainer.addEventListener('click', async (e) => {
                const tab = e.target.closest('.user-tab');
                if (tab) {
                    const user = tab.dataset.user;
                    const switchView = (targetUser) => {
                        if (appState.activeView === targetUser) return;
                        appState.activeView = targetUser; 
                        localStorage.setItem('activeView', targetUser);
                        renderUI();
                    };

                    if (e.target.closest('.delete-user-btn')) {
                        const action = async () => {
                            loadingOverlay.style.display = 'flex';
                            const entriesRef = collection(db, "journalApp", user, "entries");
                            const entriesSnapshot = await getDocs(entriesRef);
                            const batch = writeBatch(db);
                            entriesSnapshot.forEach((doc) => {
                                batch.delete(doc.ref);
                                batch.delete(doc(db, "feedEntries", doc.id));
                            });
                            await batch.commit();
                            const metadataRef = doc(db, "journalApp", "metadata");
                            const newUsers = { ...appState.users }; delete newUsers[user];
                            await updateDoc(metadataRef, { users: newUsers });
                            
                            if (appState.primaryUser === user) {
                                const newPrimary = Object.keys(newUsers).length > 0 ? Object.keys(newUsers)[0] : null;
                                localStorage.setItem('primaryUser', newPrimary);
                                appState.primaryUser = newPrimary;
                            }
                            if (appState.activeView === user) {
                                const newActive = appState.primaryUser || 'feed';
                                localStorage.setItem('activeView', newActive);
                                appState.activeView = newActive;
                            }
                            loadingOverlay.style.display = 'none';
                        };
                        if (appState.users[user].password) showModal('password', { user: user, onPassword: action });
                        else showModal('confirmDelete', { message: `'${user}' 사용자의 모든 일기가 사라집니다.`, onConfirm: action });
                    } else {
                        const needsPassword = user !== 'feed' && user !== appState.primaryUser && appState.users[user].password;
                        if (needsPassword && !unlockedUsers.has(user)) {
                             showModal('password', { 
                                 user: user, 
                                 onPassword: () => {
                                     unlockedUsers.add(user);
                                     switchView(user);
                                 } 
                             });
                        } else {
                            switchView(user);
                        }
                    }
                }
                if (e.target.closest('#add-user-btn')) showModal('addUser');
            });

            journalForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const content = journalEntry.innerHTML;
                if (!content.trim() || journalEntry.textContent.trim() === '' && !journalEntry.querySelector('img')) { return; }
                loadingOverlay.style.display = 'flex';
                // 글쓰기는 항상 primaryUser에게 저장
                const entriesRef = collection(db, "journalApp", appState.primaryUser, "entries");
                const newEntryData = { date: journalDate.value, content: content, createdAt: serverTimestamp(), likes: 0, likedBy: [] };
                const docRef = await addDoc(entriesRef, newEntryData);
                
                const feedRef = doc(db, "feedEntries", docRef.id);
                await setDoc(feedRef, { ...newEntryData, author: appState.primaryUser });

                const metadataRef = doc(db, "journalApp", "metadata");
                const updatedUsers = { ...appState.users };
                Object.keys(updatedUsers).forEach(user => { if (user !== appState.primaryUser) updatedUsers[user].hasNew = true; });
                await updateDoc(metadataRef, { users: updatedUsers });
                journalEntry.innerHTML = ''; 
                setToday();
                loadingOverlay.style.display = 'none';
            });

            entriesList.addEventListener('click', (e) => {
                const entryElement = e.target.closest('div[data-id]');
                if (!entryElement) return;
                const entryId = entryElement.dataset.id;
                const author = entryElement.dataset.author || appState.activeView;
                const entryData = appState.entries.find(entry => entry.id === entryId);

                const performAction = (action) => { if (appState.activeView !== 'feed' && appState.users[author].password) showModal('password', { user: author, onPassword: action }); else action(); };

                if (e.target.closest('.like-btn')) {
                    handleLikeClick(entryId, author);
                } else if (e.target.closest('.delete-btn')) {
                    performAction(async () => {
                        showModal('confirmDelete', { message: '이 일기를 삭제합니다.', onConfirm: async () => { 
                            await deleteDoc(doc(db, "journalApp", author, "entries", entryId));
                            await deleteDoc(doc(db, "feedEntries", entryId));
                        }});
                    });
                } else if (e.target.closest('.edit-btn')) {
                    performAction(() => {
                        showModal('edit', { content: entryData.content, onSave: async (newContent) => { 
                            const entryRef = doc(db, "journalApp", author, "entries", entryId);
                            await updateDoc(entryRef, { content: newContent });
                            const feedRef = doc(db, "feedEntries", entryId);
                            await updateDoc(feedRef, { content: newContent });
                        }});
                    });
                } else if (entryData && (e.target.closest('.entry-content-clickable') || e.target.closest('.comment-btn'))) {
                    const date = new Date(entryData.date);
                    const adjustedDate = new Date(date.getTime() + (date.getTimezoneOffset() * 60000));
                    const formattedDate = adjustedDate.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
                    showModal('viewEntry', { ...entryData, date: formattedDate, author: author });
                }
            });

            const displayRandomQuote = () => { quoteElement.textContent = `"${gratitudeQuotes[Math.floor(Math.random() * gratitudeQuotes.length)]}"`; };
            newQuoteBtn.addEventListener('click', displayRandomQuote);
            displayRandomQuote();

            // --- 앱 시작 ---
            setupEmoticons();
            initializeFirebase();
        });
    </script>
</body>
</html>

