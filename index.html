<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëª¨ë‘ì˜ ê°ì‚¬ ì¼ê¸°ì¥ (Firebase)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Icon Library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #FFFBF5; }
        .font-handwriting { font-family: 'Gaegu', cursive; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #fde8d3; }
        ::-webkit-scrollbar-thumb { background: #f59e0b; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #d97706; }
        .modal-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .delete-user-btn { opacity: 0; transition: opacity 0.2s ease-in-out; }
        .user-tab:hover .delete-user-btn { opacity: 1; }
        input[type="file"] { display: none; }
        .custom-file-upload {
            border: 1px solid #d1d5db; display: inline-block; padding: 6px 12px;
            cursor: pointer; background-color: #f9fafb; border-radius: 0.5rem;
            font-weight: 500; color: #374151; transition: background-color 0.2s;
        }
        .custom-file-upload:hover { background-color: #f3f4f6; }
        .new-badge {
            position: absolute;
            top: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 8px;
            background-color: #ef4444;
            border-radius: 50%;
            border: 1.5px solid white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .entry-content-clickable { cursor: pointer; }
        .editable-div {
            min-height: 10rem; border: 1px solid #d1d5db; border-radius: 0.5rem;
            padding: 0.5rem 1rem; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); transition: all 0.3s;
        }
        .editable-div:focus {
            outline: none; --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
            --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);
            box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
            border-color: #f59e0b; --tw-ring-color: rgb(245 158 11 / 0.5);
        }
        .editable-div:empty::before { content: "ì˜¤ëŠ˜ ì–´ë–¤ ê°ì‚¬í•œ ì¼ì´ ìˆì—ˆë‚˜ìš”?"; color: #9ca3af; cursor: text; }
        .editable-div img, .entry-content img { max-width: 100%; border-radius: 0.5rem; margin: 0.5rem 0; }
        
        .resizable-wrapper { position: relative; display: inline-block; line-height: 0; }
        .resizable-wrapper.active { outline: 2px solid #3b82f6; }
        .resize-handle {
            position: absolute; width: 12px; height: 12px;
            background-color: #3b82f6; border: 2px solid white;
            border-radius: 50%; z-index: 10;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .resize-handle.br { bottom: -6px; right: -6px; cursor: se-resize; }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #f59e0b;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite;
            position: absolute; top: 50%; left: 50%;
            margin-left: -20px; margin-top: -20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .heart-btn .fa-heart { transition: color 0.3s ease, transform 0.3s ease; }
        .heart-btn.liked .fa-heart { color: #ef4444; animation: heartBeat 0.5s ease; }
        @keyframes heartBeat {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="text-gray-800 flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-2xl mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-8 relative">
        <div id="loading-overlay" class="absolute inset-0 bg-white bg-opacity-75 z-50 flex items-center justify-center rounded-2xl">
            <div class="loader"></div>
        </div>
        
        <div class="mb-6">
            <div id="user-tabs-container" class="flex items-center space-x-2 border-b-2 border-amber-100 pb-2 overflow-x-auto"></div>
        </div>

        <header id="main-header" class="mb-6 text-center">
            <h1 id="main-title" class="text-4xl md:text-5xl font-bold text-amber-600 font-handwriting"></h1>
            <p id="main-subtitle" class="text-gray-500 mt-2">ê°ì‚¬í–ˆë˜ ì¼ë“¤ì„ ê¸°ë¡í•˜ì„¸ìš”.</p>
        </header>

        <div id="quote-container" class="mb-8 text-center bg-amber-50 border-l-4 border-amber-400 p-4 rounded-r-lg">
            <p id="gratitude-quote" class="text-gray-700 italic"></p>
            <button id="new-quote-btn" class="text-xs text-amber-600 hover:text-amber-800 mt-2 font-semibold">ë‹¤ë¥¸ ë¬¸êµ¬ ë³´ê¸°</button>
        </div>

        <form id="journal-form" class="mb-8 space-y-4">
            <div>
                <label for="journal-date" class="block text-sm font-medium text-gray-700 mb-1">ë‚ ì§œ</label>
                <input type="date" id="journal-date" class="w-full px-4 py-2 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-amber-500" required>
            </div>
            <div>
                <div class="flex justify-between items-center mb-1">
                    <label for="journal-entry" class="block text-sm font-medium text-gray-700">ê°ì‚¬í•œ ë‚´ìš©</label>
                    <p id="days-counter" class="text-amber-800 text-xs font-semibold bg-amber-100 rounded-full px-2 py-0.5" style="display: none;"></p>
                </div>
                <div id="journal-entry" contenteditable="true" class="editable-div"></div>
                 <div id="emoticon-bar" class="mt-2 flex flex-wrap justify-center gap-3 items-center p-2 bg-gray-50 rounded-lg">
                    <!-- Emoticons will be added here by JS -->
                </div>
            </div>
            <div>
                <label for="journal-photo" class="custom-file-upload"><i class="fa-solid fa-camera mr-2"></i>ì‚¬ì§„ ì¶”ê°€í•˜ê¸°</label>
                <input type="file" id="journal-photo" accept="image/*">
            </div>
            <button type="submit" class="w-full bg-amber-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-amber-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 transition-all duration-300 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">ê¸°ë¡í•˜ê¸°</button>
        </form>

        <div>
            <h2 id="entries-title" class="text-3xl font-semibold text-gray-800 border-b-2 border-amber-200 pb-2 mb-4 font-handwriting">ë‚˜ì˜ ê¸°ë¡ë“¤</h2>
            <div id="entries-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                <p id="empty-message" class="text-center text-gray-500 py-4">ì•„ì§ ì‘ì„±ëœ ì¼ê¸°ê°€ ì—†ì–´ìš”.</p>
            </div>
        </div>
    </div>

    <div id="modal-container"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, getDocs, writeBatch, runTransaction, serverTimestamp, orderBy, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- ì „ì—­ ë³€ìˆ˜ ë° ìƒìˆ˜ ---
        const gratitudeQuotes = [ "ê°ì‚¬í•˜ëŠ” ë§ˆìŒì€ ìµœê³ ì˜ ë¯¸ë•ì¼ ë¿ë§Œ ì•„ë‹ˆë¼, ëª¨ë“  ë¯¸ë•ì˜ ì•„ë²„ì§€ì´ë‹¤.", "ì„¸ìƒì—ì„œ ê°€ì¥ ì¦ê±°ìš´ ì¼ì€ ê°ì‚¬í•˜ëŠ” ë§ˆìŒìœ¼ë¡œ ì‚¬ëŠ” ê²ƒì´ë‹¤.", "ê°ì‚¬ëŠ” ë§ˆìŒì˜ ê¸°ì–µì´ë‹¤.", "ì‘ì€ ê²ƒì— ê°ì‚¬í•  ë•Œ, ìš°ë¦¬ëŠ” ë” ë§ì€ ê²ƒì„ ë°›ì„ ì¤€ë¹„ê°€ ëœë‹¤.", "ë§¤ì¼ ì•„ì¹¨ ëˆˆì„ ëœ° ë•Œë§ˆë‹¤ ì‚´ì•„ìˆìŒì— ê°ì‚¬í•˜ë¼.", "ê°ì‚¬í•  ì¤„ ì•„ëŠ” ì‚¬ëŒì—ê²ŒëŠ” ë¶€ì¡±í•¨ì´ ì—†ë‹¤.", "í–‰ë³µì€ ê°ì‚¬ì˜ ë¬¸ìœ¼ë¡œ ë“¤ì–´ì˜¨ë‹¤.", "ê°ì‚¬ëŠ” í‰ë²”í•œ ë‚ ì„ ì¶”ìˆ˜ê°ì‚¬ì ˆë¡œ ë°”ê¾¼ë‹¤.", "ìˆ¨ ì‰´ ìˆ˜ ìˆìŒì— ê°ì‚¬í•˜ê³ , ì‚´ì•„ ìˆìŒì— ê°ì‚¬í•˜ë¼.", "ê°ì‚¬í•˜ëŠ” ë§ˆìŒì€ ì˜í˜¼ì„ ìœ„í•œ ìµœê³ ì˜ íœ´ì‹ì´ë‹¤.", "ì„¸ìƒì—ì„œ ê°€ì¥ ì•„ë¦„ë‹¤ìš´ ê¸°ë„ëŠ” 'ê°ì‚¬í•©ë‹ˆë‹¤'ì´ë‹¤.", "í–‡ì‚´ í•œ ì¤Œ, ë°”ëŒ í•œ ì ì—ë„ ê°ì‚¬í•  ì´ìœ ê°€ ìˆë‹¤.", "ë‹¹ì—°í•˜ê²Œ ì—¬ê²¼ë˜ ëª¨ë“  ê²ƒë“¤ì´ ì‚¬ì‹¤ì€ ê¸°ì ì´ì—ˆë‹¤.", "ê°ì‚¬ëŠ” í–‰ë³µìœ¼ë¡œ ê°€ëŠ” ê°€ì¥ ë¹ ë¥¸ ê¸¸ì´ë‹¤.", "ì˜¤ëŠ˜ ë‚´ê°€ ë°›ì€ ëª¨ë“  ê²ƒì— ê°ì‚¬í•œë‹¤.", "ì‘ì€ ê¸°ì¨ë“¤ì´ ëª¨ì—¬ í° í–‰ë³µì„ ë§Œë“ ë‹¤.", "ë§¤ì¼ì´ ì„ ë¬¼ì´ë¼ëŠ” ê²ƒì„ ê¸°ì–µí•˜ë¼.", "ê°ì‚¬í• ìˆ˜ë¡ ê°ì‚¬í•  ì¼ì´ ë” ë§ì´ ìƒê¸´ë‹¤.", "ê°ì‚¬ëŠ” ê³¼ê±°ë¥¼ ì´í•´í•˜ê²Œ í•˜ê³ , í˜„ì¬ì— í‰í™”ë¥¼ ê°€ì ¸ì˜¤ë©°, ë¯¸ë˜ì— ëŒ€í•œ ë¹„ì „ì„ ì°½ì¡°í•œë‹¤.", "ê°€ì¥ í° ì¶•ë³µì€ ë³´ì´ì§€ ì•ŠëŠ” ê³³ì— ìˆë‹¤.", "ì˜¤ëŠ˜ í•˜ë£¨ë„ ë¬´ì‚¬íˆ ë³´ëƒˆìŒì— ê°ì‚¬í•œë‹¤.", "ê±´ê°•í•œ ëª¸ê³¼ ë§ˆìŒì„ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.", "ë§›ìˆëŠ” ìŒì‹ì„ ë¨¹ì„ ìˆ˜ ìˆìŒì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ë”°ëœ»í•œ ì§‘ì´ ìˆë‹¤ëŠ” ê²ƒì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ë‚˜ë¥¼ ì‚¬ë‘í•´ì£¼ëŠ” ì‚¬ëŒë“¤ì´ ê³ì— ìˆì–´ ê°ì‚¬í•©ë‹ˆë‹¤.", "ë°°ìš¸ ìˆ˜ ìˆëŠ” ê¸°íšŒê°€ ìˆìŒì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ì•„ì¹¨ì— ëˆˆì„ ëœ° ìˆ˜ ìˆë‹¤ëŠ” ì‚¬ì‹¤ì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ì‹¤ìˆ˜ë¡œë¶€í„° ë°°ìš¸ ìˆ˜ ìˆìŒì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ì•„ë¦„ë‹¤ìš´ ìŒì•…ì„ ë“¤ì„ ìˆ˜ ìˆìŒì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ë§‘ì€ ê³µê¸°ë¥¼ ë§ˆì‹¤ ìˆ˜ ìˆìŒì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ì˜¤ëŠ˜ì˜ ë‚ ì”¨ì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ë‚˜ ìì‹ ìœ¼ë¡œ ì‚´ì•„ê°ˆ ìˆ˜ ìˆìŒì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ì›ƒì„ ìˆ˜ ìˆëŠ” ìˆœê°„ë“¤ì— ê°ì‚¬í•©ë‹ˆë‹¤.", "í˜ë“¤ ë•Œ ê¸°ëŒˆ ìˆ˜ ìˆëŠ” ì¹œêµ¬ê°€ ìˆì–´ ê°ì‚¬í•©ë‹ˆë‹¤.", "ìƒˆë¡œìš´ í•˜ë£¨ë¥¼ ì‹œì‘í•  í˜ì„ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.", "ì¢‹ì€ ì±…ì„ ì½ì„ ìˆ˜ ìˆëŠ” ì‹œê°„ì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ë‚˜ë¥¼ ì„±ì¥ì‹œí‚¤ëŠ” ëª¨ë“  ê²½í—˜ì— ê°ì‚¬í•©ë‹ˆë‹¤.", "í‰í™”ë¡œìš´ ìˆœê°„ë“¤ì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ë”°ëœ»í•œ ì°¨ í•œì”ì˜ ì—¬ìœ ì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ë‚˜ì˜ ê¿ˆì„ ì‘ì›í•´ì£¼ëŠ” ì‚¬ëŒë“¤ì´ ìˆì–´ ê°ì‚¬í•©ë‹ˆë‹¤.", "ì˜¤ëŠ˜ í•˜ë£¨ ë™ì•ˆ ë§Œë‚œ ëª¨ë“  ì¸ì—°ì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ê¹¨ë—í•œ ë¬¼ì„ ë§ˆì‹¤ ìˆ˜ ìˆìŒì— ê°ì‚¬í•©ë‹ˆë‹¤.", "í¸ì•ˆí•œ ì ìë¦¬ì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ìì—°ì˜ ì•„ë¦„ë‹¤ì›€ì„ ëŠë‚„ ìˆ˜ ìˆìŒì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ë‚˜ì˜ ë…¸ë ¥ì„ ì•Œì•„ì£¼ëŠ” ì‚¬ëŒì´ ìˆìŒì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ìš©ì„œí•  ìˆ˜ ìˆëŠ” ë§ˆìŒì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ì‚¬ë‘ì„ ì£¼ê³ ë°›ì„ ìˆ˜ ìˆìŒì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ì˜¤ëŠ˜ í˜ë¦° ë•€ë°©ìš¸ì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ë‚˜ë¥¼ ë¯¿ì–´ì£¼ëŠ” ë§ˆìŒì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ì‘ì€ ì¹œì ˆì„ ë² í’€ ìˆ˜ ìˆëŠ” ê¸°íšŒì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ë„˜ì–´ì ¸ë„ ë‹¤ì‹œ ì¼ì–´ì„¤ ìˆ˜ ìˆëŠ” ìš©ê¸°ì— ê°ì‚¬í•©ë‹ˆë‹¤.", "í•¨ê»˜ ì›ƒê³  ë– ë“¤ ìˆ˜ ìˆëŠ” ë™ë£Œê°€ ìˆì–´ ê°ì‚¬í•©ë‹ˆë‹¤.", "ì˜¤ëŠ˜ í•˜ë£¨ë„ ìˆ˜ê³ í•œ ë‚˜ ìì‹ ì—ê²Œ ê°ì‚¬í•©ë‹ˆë‹¤.", "ìƒˆë¡œìš´ ê²ƒì„ ë°°ìš¸ ìˆ˜ ìˆëŠ” í˜¸ê¸°ì‹¬ì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ì–´ë ¤ì›€ì„ ê·¹ë³µí•  ìˆ˜ ìˆëŠ” ì§€í˜œì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ë‚˜ë¥¼ í•„ìš”ë¡œ í•˜ëŠ” ê³³ì´ ìˆìŒì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ë”°ëœ»í•œ í–‡ì‚´ ì•„ë˜ ì‚°ì±…í•  ìˆ˜ ìˆìŒì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ê°€ì¡±ë“¤ì˜ ê±´ê°•ì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ì˜¤ëŠ˜ì˜ ì†Œì†Œí•œ í–‰ë³µì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ë‚˜ë¥¼ ì›ƒê²Œ ë§Œë“œëŠ” ëª¨ë“  ê²ƒì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ê³ ìš”í•œ ì•„ì¹¨ ì‹œê°„ì— ê°ì‚¬í•©ë‹ˆë‹¤.", "í¸ì•ˆí•˜ê²Œ ì‰´ ìˆ˜ ìˆëŠ” ì£¼ë§ì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ëª©í‘œë¥¼ í–¥í•´ ë‚˜ì•„ê°ˆ ìˆ˜ ìˆìŒì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ë‚˜ì˜ ê°ì •ì„ ì†”ì§í•˜ê²Œ í‘œí˜„í•  ìˆ˜ ìˆìŒì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ë„ì›€ì´ í•„ìš”í•  ë•Œ ì† ë‚´ë°€ì–´ì£¼ëŠ” ì‚¬ëŒë“¤ì—ê²Œ ê°ì‚¬í•©ë‹ˆë‹¤.", "ì•„ë¦„ë‹¤ìš´ ë…¸ì„ì„ ë³¼ ìˆ˜ ìˆìŒì— ê°ì‚¬í•©ë‹ˆë‹¤.", "í¬ê¸°í•˜ì§€ ì•ŠëŠ” ë‚˜ì˜ ëˆê¸°ì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ì¢‹ì€ ì˜í™” í•œ í¸ ë³¼ ìˆ˜ ìˆëŠ” ì—¬ìœ ì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ë‚˜ì˜ ë¶€ì¡±í•¨ì„ ì±„ì›Œì£¼ëŠ” ì‚¬ëŒë“¤ì—ê²Œ ê°ì‚¬í•©ë‹ˆë‹¤.", "ì˜¤ëŠ˜ í•˜ë£¨ë„ ìµœì„ ì„ ë‹¤í•œ ë‚˜ì—ê²Œ ê°ì‚¬í•©ë‹ˆë‹¤.", "í¸ì•ˆí•œ ì‹ ë°œì„ ì‹ ê³  ê±¸ì„ ìˆ˜ ìˆìŒì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ë°¤í•˜ëŠ˜ì˜ ë³„ì„ ë³¼ ìˆ˜ ìˆìŒì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ì‹œì›í•œ ë°”ëŒì„ ëŠë‚„ ìˆ˜ ìˆìŒì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ë‚˜ë¥¼ ì‘ì›í•˜ëŠ” ëŒ“ê¸€ í•˜ë‚˜ì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ì–´ì œì˜ ë‚˜ë³´ë‹¤ ì„±ì¥í•œ ì˜¤ëŠ˜ì˜ ë‚˜ì—ê²Œ ê°ì‚¬í•©ë‹ˆë‹¤.", "ì°½ë°–ì— ë‚´ë¦¬ëŠ” ë¹—ì†Œë¦¬ì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ë‚˜ì˜ ì´ì•¼ê¸°ë¥¼ ë“¤ì–´ì£¼ëŠ” ì‚¬ëŒì´ ìˆìŒì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ê±´ê°•í•˜ê²Œ ì¼í•  ìˆ˜ ìˆëŠ” ì§ì¥ì´ ìˆìŒì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ìƒˆë¡œìš´ ì•„ì´ë””ì–´ê°€ ë– ì˜¤ë¥¸ ìˆœê°„ì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ë‚˜ë¥¼ ë‘˜ëŸ¬ì‹¼ ëª¨ë“  ê²ƒë“¤ì˜ ì¡°í™”ì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ì–´ë ¤ìš´ ë¬¸ì œë¥¼ í•´ê²°í–ˆì„ ë•Œì˜ ì„±ì·¨ê°ì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ë‚˜ë¥¼ ìˆëŠ” ê·¸ëŒ€ë¡œ ë°›ì•„ë“¤ì—¬ ì£¼ëŠ” ì‚¬ëŒë“¤ì—ê²Œ ê°ì‚¬í•©ë‹ˆë‹¤.", "ì˜¤ëŠ˜ë„ ë¬´ì–¸ê°€ë¥¼ í•´ëƒˆë‹¤ëŠ” ì‚¬ì‹¤ì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ë‹¬ì½¤í•œ ê°„ì‹ì„ ë¨¹ì„ ìˆ˜ ìˆëŠ” ì¦ê±°ì›€ì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ì¢‹ì€ í–¥ê¸°ë¥¼ ë§¡ì„ ìˆ˜ ìˆìŒì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ë‚˜ì˜ ì‘ì€ ë…¸ë ¥ì´ ëˆ„êµ°ê°€ì—ê²Œ ë„ì›€ì´ ë˜ì—ˆì„ ë•Œ ê°ì‚¬í•©ë‹ˆë‹¤.", "ì„¸ìƒì˜ ëª¨ë“  ì§€ì‹ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŒì— ê°ì‚¬í•©ë‹ˆë‹¤.", "í˜ë“  í•˜ë£¨ ëì— ë§ˆì‹œëŠ” ì‹œì›í•œ ë¬¼ í•œ ì”ì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ë‚˜ì˜ ì„ íƒì„ ì¡´ì¤‘í•´ì£¼ëŠ” ì‚¬ëŒë“¤ì—ê²Œ ê°ì‚¬í•©ë‹ˆë‹¤.", "ì˜¤ëŠ˜ í•˜ë£¨ ë™ì•ˆ ëŠë‚€ ëª¨ë“  ê°ì •ì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•Šê³  ì‰´ ìˆ˜ ìˆëŠ” ì‹œê°„ì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ë‚˜ì˜ ì¬ëŠ¥ì„ ë‚˜ëˆŒ ìˆ˜ ìˆìŒì— ê°ì‚¬í•©ë‹ˆë‹¤.", "ì„¸ìƒì€ ì—¬ì „íˆ ì•„ë¦„ë‹µë‹¤ëŠ” ê²ƒì„ ëŠë‚„ ë•Œ ê°ì‚¬í•©ë‹ˆë‹¤.", "ì‹¤íŒ¨ëŠ” ì„±ê³µì˜ ì–´ë¨¸ë‹ˆì„ì„ ì•Œê²Œ í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.", "ì˜¤ëŠ˜ í•˜ë£¨ë„ ì‚´ì•„ìˆìŒì— ê°ì‚¬í•©ë‹ˆë‹¤." ];

        let db, auth, storage;
        let appState = { users: {}, activeView: null, primaryUser: null, entries: [] };
        let metadataUnsubscribe = null;
        let entriesUnsubscribe = null;
        let commentsUnsubscribe = null;
        let savedRange = null;
        let unlockedUsers = new Set(); // ë¹„ë°€ë²ˆí˜¸ í•´ì œí•œ ì‚¬ìš©ì ì €ì¥

        document.addEventListener('DOMContentLoaded', () => {
            const journalForm = document.getElementById('journal-form');
            const journalDate = document.getElementById('journal-date');
            const journalEntry = document.getElementById('journal-entry');
            const journalPhoto = document.getElementById('journal-photo');
            const entriesList = document.getElementById('entries-list');
            const emptyMessage = document.getElementById('empty-message');
            const quoteElement = document.getElementById('gratitude-quote');
            const newQuoteBtn = document.getElementById('new-quote-btn');
            const userTabsContainer = document.getElementById('user-tabs-container');
            const mainHeader = document.getElementById('main-header');
            const mainTitle = document.getElementById('main-title');
            const mainSubtitle = document.getElementById('main-subtitle');
            const entriesTitle = document.getElementById('entries-title');
            const modalContainer = document.getElementById('modal-container');
            const loadingOverlay = document.getElementById('loading-overlay');
            const quoteContainer = document.getElementById('quote-container');
            const daysCounter = document.getElementById('days-counter');

            const setToday = () => {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                journalDate.value = `${year}-${month}-${day}`;
            };
            setToday();

            // --- Firebase ì´ˆê¸°í™” ë° ì¸ì¦ ---
            async function initializeFirebase() {
                const firebaseConfig = { apiKey: "AIzaSyDIKlFzyguBn9p4iQzI53DGdFb79Xqcqyg", authDomain: "gam-sa-ilgi.firebaseapp.com", projectId: "gam-sa-ilgi", storageBucket: "gam-sa-ilgi.appspot.com", messagingSenderId: "459918214357", appId: "1:459918214357:web:2eff745e4a128f7d67ce5c", measurementId: "G-0JTV8VKBEJ" };
                if (!firebaseConfig.apiKey) { loadingOverlay.innerHTML = "Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤."; return; }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app); auth = getAuth(app); storage = getStorage(app);
                onAuthStateChanged(auth, async (user) => {
                    if (user) { await setupListeners(); } 
                    else { try { await signInAnonymously(auth); } catch (error) { console.error("ìµëª… ë¡œê·¸ì¸ ì‹¤íŒ¨:", error); loadingOverlay.innerHTML = "ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."; } }
                });
            }

            // --- ë°ì´í„° ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---
            async function setupListeners() {
                const metadataRef = doc(db, "journalApp", "metadata");
                metadataUnsubscribe = onSnapshot(metadataRef, async (docSnap) => {
                    const lastActiveView = localStorage.getItem('activeView');
                    let localPrimaryUser = localStorage.getItem('primaryUser');

                    if (docSnap.exists() && Object.keys(docSnap.data().users).length > 0) {
                        appState.users = docSnap.data().users;
                        if (!localPrimaryUser || !appState.users[localPrimaryUser]) {
                            localPrimaryUser = Object.keys(appState.users)[0];
                            localStorage.setItem('primaryUser', localPrimaryUser);
                        }
                        appState.primaryUser = localPrimaryUser;
                        appState.activeView = (lastActiveView && (lastActiveView === 'feed' || appState.users[lastActiveView])) ? lastActiveView : 'feed';
                    } else {
                        const defaultUser = 'ë˜ë¯¼';
                        appState.users = { [defaultUser]: { password: null, hasNew: false } };
                        appState.activeView = defaultUser;
                        appState.primaryUser = defaultUser;
                        localStorage.setItem('primaryUser', defaultUser);
                        localStorage.setItem('activeView', defaultUser);
                        await setDoc(metadataRef, { users: appState.users });
                    }
                    if (appState.activeView !== 'feed' && appState.users[appState.activeView] && appState.users[appState.activeView].hasNew) {
                        appState.users[appState.activeView].hasNew = false;
                        await updateDoc(metadataRef, { users: appState.users });
                    }
                    renderUI();
                }, (error) => { console.error("ë©”íƒ€ë°ì´í„° ê°ì‹œ ì‹¤íŒ¨:", error); loadingOverlay.innerHTML = "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."; });
            }
            
            function renderUI() {
                renderTabs();
                updateTitleAndForm();
                if (appState.activeView === 'feed') {
                    setupFeedListener();
                } else {
                    setupEntriesListener();
                }
            }

            function setupEntriesListener() {
                if (entriesUnsubscribe) entriesUnsubscribe();
                if (!appState.activeView || appState.activeView === 'feed') return;
                const entriesRef = collection(db, "journalApp", appState.activeView, "entries");
                const q = query(entriesRef, orderBy("date", "desc"));
                entriesUnsubscribe = onSnapshot(q, (querySnapshot) => {
                    appState.entries = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderEntries();
                    loadingOverlay.style.display = 'none';
                }, (error) => { console.error("ì¼ê¸° ê°ì‹œ ì‹¤íŒ¨:", error); });
            }

            function setupFeedListener() {
                if (entriesUnsubscribe) entriesUnsubscribe();
                const feedRef = collection(db, "feedEntries");
                const q = query(feedRef, orderBy("createdAt", "desc"));
                entriesUnsubscribe = onSnapshot(q, (querySnapshot) => {
                    appState.entries = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderFeedEntries();
                    loadingOverlay.style.display = 'none';
                }, (error) => { console.error("í”¼ë“œ ê°ì‹œ ì‹¤íŒ¨:", error); });
            }

            // --- ëª¨ë‹¬ ê´€ë¦¬ ---
            const showModal = (type, data = {}) => {
                modalContainer.innerHTML = ''; 
                let modalHtml = '';
                switch (type) {
                    case 'edit':
                        modalHtml = `<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4"><div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 w-full max-w-lg modal-fade-in"><h2 class="text-2xl font-bold mb-4">ì¼ê¸° ìˆ˜ì •í•˜ê¸°</h2><div id="edit-entry-div" contenteditable="true" class="editable-div mb-4">${data.content}</div><div><label for="edit-journal-photo" class="custom-file-upload"><i class="fa-solid fa-camera mr-2"></i>ì‚¬ì§„ ì¶”ê°€í•˜ê¸°</label><input type="file" id="edit-journal-photo" accept="image/*"></div><div class="mt-6 flex justify-end space-x-3"><button class="modal-cancel-btn px-4 py-2 bg-gray-200 rounded-lg">ì·¨ì†Œ</button><button id="save-edit-btn" class="px-4 py-2 bg-amber-500 text-white rounded-lg">ì €ì¥í•˜ê¸°</button></div></div></div>`;
                        break;
                    case 'addUser':
                        modalHtml = `<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4"><form id="add-user-form" class="bg-white rounded-2xl shadow-xl p-6 md:p-8 w-full max-w-sm modal-fade-in space-y-4"><h2 class="text-2xl font-bold">ìƒˆ ì‚¬ìš©ì ì¶”ê°€</h2><div><label>ì´ë¦„</label><input type="text" id="new-user-name" class="w-full px-4 py-2 border rounded-lg" required></div><div><label>ë¹„ë°€ë²ˆí˜¸ (ì„ íƒ)</label><input type="password" id="new-user-password" class="w-full px-4 py-2 border rounded-lg"></div><div id="user-error-msg" class="text-red-500 text-sm h-5"></div><div class="mt-2 flex justify-end space-x-3"><button type="button" class="modal-cancel-btn px-4 py-2 bg-gray-200 rounded-lg">ì·¨ì†Œ</button><button type="submit" class="px-4 py-2 bg-green-500 text-white rounded-lg">ì¶”ê°€í•˜ê¸°</button></div></form></div>`;
                        break;
                    case 'confirmDelete':
                        modalHtml = `<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4"><div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 w-full max-w-sm modal-fade-in text-center"><h2 class="text-xl font-bold mb-2">ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h2><p class="text-gray-600 mb-6">${data.message}</p><div class="flex justify-center space-x-4"><button class="modal-cancel-btn px-6 py-2 bg-gray-200 rounded-lg">ì·¨ì†Œ</button><button id="confirm-delete-btn" class="px-6 py-2 bg-red-500 text-white rounded-lg">ì‚­ì œ</button></div></div></div>`;
                        break;
                    case 'password':
                        modalHtml = `<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4"><form id="password-form" class="bg-white rounded-2xl shadow-xl p-6 md:p-8 w-full max-w-sm modal-fade-in"><h2 class="text-2xl font-bold mb-4">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</h2><input type="password" id="password-input" class="w-full px-4 py-2 border rounded-lg" required><div id="password-error-msg" class="text-red-500 text-sm mt-2 h-5"></div><div class="mt-2 flex justify-end space-x-3"><button type="button" class="modal-cancel-btn px-4 py-2 bg-gray-200 rounded-lg">ì·¨ì†Œ</button><button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg">í™•ì¸</button></div></form></div>`;
                        break;
                    case 'viewEntry':
                        const liked = data.likedBy && data.likedBy.includes(auth.currentUser.uid);
                        modalHtml = `
                        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4" id="view-modal-backdrop">
                            <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl modal-fade-in flex flex-col max-h-[90vh]">
                                <div class="p-6 border-b">
                                    <div class="flex justify-between items-center">
                                        <h2 class="text-xl md:text-2xl font-bold">${data.author}ë‹˜ì˜ ${data.date} ì¼ê¸°</h2>
                                        <button class="modal-cancel-btn text-2xl text-gray-500 hover:text-gray-800">&times;</button>
                                    </div>
                                </div>
                                <div class="p-6 overflow-y-auto flex-grow">
                                    <div class="entry-content whitespace-pre-wrap">${data.content}</div>
                                </div>
                                <div class="p-6 border-t bg-gray-50 rounded-b-2xl">
                                    <div class="flex items-center justify-between mb-2">
                                        <button id="like-btn" class="heart-btn ${liked ? 'liked' : ''} text-2xl text-gray-400"><i class="fa-solid fa-heart"></i></button>
                                        <span id="like-count" class="text-sm text-gray-600">${data.likes || 0}ëª…ì´ ì¢‹ì•„í•©ë‹ˆë‹¤</span>
                                    </div>
                                    <div id="comments-section" class="space-y-2 max-h-32 overflow-y-auto mb-2"></div>
                                    <form id="comment-form" class="flex space-x-2">
                                        <input id="comment-input" type="text" class="flex-grow border rounded-lg px-3 py-2 text-sm" placeholder="ìµëª… ëŒ“ê¸€ ë‹¬ê¸°..." required>
                                        <button type="submit" class="bg-amber-500 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-amber-600">ë“±ë¡</button>
                                    </form>
                                </div>
                            </div>
                        </div>`;
                        break;
                }
                modalContainer.innerHTML = modalHtml;

                const closeModal = () => { if(commentsUnsubscribe) commentsUnsubscribe(); modalContainer.innerHTML = ''; };
                modalContainer.querySelectorAll('.modal-cancel-btn, #view-modal-backdrop').forEach(btn => btn.addEventListener('click', (e) => { if(e.target === e.currentTarget) closeModal(); }));

                if (data.onConfirm) modalContainer.querySelector('#confirm-delete-btn')?.addEventListener('click', () => { data.onConfirm(); closeModal(); });
                if (data.onSave) modalContainer.querySelector('#save-edit-btn')?.addEventListener('click', () => { data.onSave(modalContainer.querySelector('#edit-entry-div').innerHTML); closeModal(); });
                if (data.onPassword) {
                    const form = modalContainer.querySelector('#password-form');
                    form?.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const password = form.querySelector('#password-input').value;
                        if (appState.users[data.user].password === password) { data.onPassword(); closeModal(); } 
                        else { form.querySelector('#password-error-msg').textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.'; }
                    });
                }
                if (type === 'addUser') {
                    modalContainer.querySelector('#add-user-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const newUser = modalContainer.querySelector('#new-user-name').value.trim();
                        const password = modalContainer.querySelector('#new-user-password').value;
                        const errorMsg = modalContainer.querySelector('#user-error-msg');
                        if (newUser && !appState.users[newUser]) {
                            const metadataRef = doc(db, "journalApp", "metadata");
                            const newUsers = { ...appState.users, [newUser]: { password: password || null, hasNew: false } };
                            await updateDoc(metadataRef, { users: newUsers });
                            appState.activeView = newUser; localStorage.setItem('activeView', newUser); closeModal();
                        } else { errorMsg.textContent = appState.users[newUser] ? 'ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¦„ì…ë‹ˆë‹¤.' : 'ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'; }
                    });
                }
                 if (type === 'edit') {
                    const editEntryDiv = modalContainer.querySelector('#edit-entry-div');
                    const editPhotoInput = modalContainer.querySelector('#edit-journal-photo');
                    let editSavedRange = null;

                    editEntryDiv.addEventListener('blur', () => {
                        const selection = window.getSelection();
                        if (selection.rangeCount > 0) {
                            editSavedRange = selection.getRangeAt(0);
                        }
                    });

                    editPhotoInput.addEventListener('change', async (e) => {
                        const file = e.target.files[0]; if (!file) return;
                        const loadingOverlay = document.getElementById('loading-overlay');
                        loadingOverlay.style.display = 'flex';
                        const userId = auth.currentUser.uid;
                        const filePath = `journalImages/${userId}/${Date.now()}-${file.name}`;
                        const storageRef = ref(storage, filePath);
                        try {
                            await uploadBytes(storageRef, file);
                            const url = await getDownloadURL(storageRef);
                            const img = document.createElement('img');
                            img.src = url;
                            editEntryDiv.focus();
                            const selection = window.getSelection();
                            if (editSavedRange) {
                                selection.removeAllRanges();
                                selection.addRange(editSavedRange);
                            }
                            if (selection.getRangeAt && selection.rangeCount) {
                                let range = selection.getRangeAt(0);
                                range.deleteContents();
                                range.insertNode(img);
                                const space = document.createTextNode("\u00A0");
                                range.insertNode(space);
                                range.setStartAfter(space);
                                range.collapse(true);
                                selection.removeAllRanges();
                                selection.addRange(range);
                            }
                        } catch (error) {
                            console.error("ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨:", error);
                        } finally {
                            editPhotoInput.value = '';
                            loadingOverlay.style.display = 'none';
                        }
                    });
                }
                if (type === 'viewEntry') {
                    const commentsRef = collection(db, "journalApp", data.author, "entries", data.id, "comments");
                    const q = query(commentsRef, orderBy("createdAt", "asc"));
                    commentsUnsubscribe = onSnapshot(q, (snapshot) => {
                        const commentsSection = document.getElementById('comments-section');
                        if (!commentsSection) return;
                        commentsSection.innerHTML = '';
                        snapshot.forEach(doc => {
                            const comment = doc.data();
                            const div = document.createElement('div'); div.className = "text-sm bg-gray-100 p-2 rounded-lg";
                            div.innerHTML = `<span class="font-semibold mr-2">ìµëª…</span><span>${comment.text}</span>`;
                            commentsSection.appendChild(div);
                        });
                    });
                    document.getElementById('comment-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const input = document.getElementById('comment-input');
                        if (!input.value.trim()) return;
                        await addDoc(commentsRef, { text: input.value, createdAt: serverTimestamp() });
                        input.value = '';
                    });
                    document.getElementById('like-btn').addEventListener('click', () => handleLikeClick(data.id, data.author));
                }
            };

            // --- ë Œë”ë§ í•¨ìˆ˜ ---
            const renderTabs = () => {
                userTabsContainer.innerHTML = '';
                const feedTab = document.createElement('button');
                feedTab.className = `user-tab relative flex-shrink-0 px-4 py-2 text-sm font-semibold rounded-t-lg transition-colors duration-200 ${appState.activeView === 'feed' ? 'bg-amber-500 text-white' : 'text-gray-500 hover:bg-amber-100'}`;
                feedTab.textContent = 'ëª¨ë‘';
                feedTab.dataset.user = 'feed';
                userTabsContainer.appendChild(feedTab);

                Object.keys(appState.users).forEach(user => {
                    const isActive = user === appState.activeView;
                    const tab = document.createElement('button');
                    tab.className = `user-tab relative flex-shrink-0 px-4 py-2 text-sm font-semibold rounded-t-lg transition-colors duration-200 ${isActive ? 'bg-amber-500 text-white' : 'text-gray-500 hover:bg-amber-100'}`;
                    tab.textContent = user;
                    tab.dataset.user = user;
                    if (appState.users[user].hasNew) tab.innerHTML += `<span class="new-badge"></span>`;
                    if (Object.keys(appState.users).length > 0) {
                        tab.innerHTML += `<span class="delete-user-btn absolute -top-1 -right-1 text-red-500 bg-white rounded-full w-4 h-4 flex items-center justify-center text-xs"><i class="fas fa-times-circle"></i></span>`;
                    }
                    userTabsContainer.appendChild(tab);
                });
                const addUserBtn = document.createElement('button');
                addUserBtn.id = 'add-user-btn';
                addUserBtn.className = 'ml-2 px-3 py-1 bg-green-500 text-white rounded-full text-sm font-bold hover:bg-green-600 transition-transform hover:scale-110';
                addUserBtn.innerHTML = '<i class="fas fa-plus"></i>';
                userTabsContainer.appendChild(addUserBtn);
            };
            const updateTitleAndForm = () => {
                const isFeed = appState.activeView === 'feed';

                if (isFeed) {
                    mainHeader.style.display = 'block';
                    mainTitle.textContent = 'ëª¨ë‘ì˜ ê°ì‚¬ì¼ê¸°';
                    mainSubtitle.textContent = 'ë‹¤ë¥¸ ì‚¬ëŒë“¤ì˜ ê°ì‚¬í•œ í•˜ë£¨ë¥¼ ë‘˜ëŸ¬ë³´ì„¸ìš”.';
                    entriesTitle.textContent = 'ëª¨ë‘ì˜ ê¸°ë¡ë“¤';
                    journalForm.style.display = 'none';
                    quoteContainer.style.display = 'none';
                    daysCounter.style.display = 'none';
                } else {
                    mainHeader.style.display = 'block';
                    mainTitle.textContent = `${appState.activeView || ''}ì˜ ê°ì‚¬ ì¼ê¸°ì¥`;
                    mainSubtitle.textContent = 'ê°ì‚¬í–ˆë˜ ì¼ë“¤ì„ ê¸°ë¡í•˜ì„¸ìš”.';
                    entriesTitle.textContent = `${appState.activeView || ''}ë‹˜ì˜ ê¸°ë¡ë“¤`;
                    quoteContainer.style.display = 'block';
                    journalForm.style.display = 'block';
                }
            };
            const renderEntries = () => {
                entriesList.innerHTML = '';
                if (appState.entries.length === 0) {
                    entriesList.appendChild(emptyMessage);
                    emptyMessage.style.display = 'block';
                    daysCounter.style.display = 'none';
                } else {
                    daysCounter.style.display = 'block';
                    const firstEntryDateStr = appState.entries[appState.entries.length - 1].date;
                    const [year, month, day] = firstEntryDateStr.split('-').map(Number);
                    const firstDate = new Date(year, month - 1, day);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    firstDate.setHours(0,0,0,0);
                    
                    const diffTime = today.getTime() - firstDate.getTime();
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    daysCounter.innerHTML = `ğŸ§¡ ${diffDays}ì¼ì§¸ ê°ì‚¬ ê¸°ë¡ì¤‘ ğŸ§¡`;

                    emptyMessage.style.display = 'none';
                    appState.entries.forEach(entry => {
                        const entryElement = document.createElement('div');
                        entryElement.className = 'bg-amber-50 p-4 rounded-xl border border-amber-200';
                        entryElement.dataset.id = entry.id;
                        const date = new Date(entry.date);
                        const adjustedDate = new Date(date.getTime() + (date.getTimezoneOffset() * 60000));
                        const formattedDate = adjustedDate.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = entry.content;
                        const textPreview = tempDiv.textContent || tempDiv.innerText || "";
                        const liked = entry.likedBy && entry.likedBy.includes(auth.currentUser.uid);

                        entryElement.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <p class="font-semibold text-amber-800">${formattedDate}</p>
                                <div class="flex space-x-2">
                                    <button class="edit-btn text-gray-400 hover:text-green-600 text-xs font-bold py-1 px-2 rounded">ìˆ˜ì •</button>
                                    <button class="delete-btn text-gray-400 hover:text-red-500 text-xs font-bold py-1 px-2 rounded">ì‚­ì œ</button>
                                </div>
                            </div>
                            <div class="entry-content-clickable cursor-pointer">
                                <p class="text-gray-700 whitespace-pre-wrap truncate">${textPreview}</p>
                            </div>
                            <div class="flex items-center space-x-4 text-sm text-gray-500 mt-2 pt-2 border-t border-amber-100">
                                <button class="like-btn heart-btn ${liked ? 'liked' : ''} flex items-center space-x-1 hover:text-red-500">
                                    <i class="fa-solid fa-heart"></i> 
                                    <span>${entry.likes || 0}</span>
                                </button>
                                <button class="comment-btn flex items-center space-x-1 hover:text-blue-500">
                                    <i class="fa-regular fa-comment"></i>
                                    <span>ëŒ“ê¸€</span>
                                </button>
                            </div>`;
                        entriesList.appendChild(entryElement);
                    });
                }
            };
            const renderFeedEntries = () => {
                daysCounter.style.display = 'none';
                entriesList.innerHTML = '';
                if (appState.entries.length === 0) {
                    entriesList.appendChild(emptyMessage);
                    emptyMessage.style.display = 'block';
                } else {
                    emptyMessage.style.display = 'none';
                    appState.entries.forEach(entry => {
                        const entryElement = document.createElement('div');
                        entryElement.className = 'bg-amber-50 p-4 rounded-xl border border-amber-200';
                        entryElement.dataset.id = entry.id;
                        entryElement.dataset.author = entry.author;
                        const date = entry.createdAt.toDate();
                        const formattedDate = date.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = entry.content;
                        const textPreview = tempDiv.textContent || tempDiv.innerText || "";
                        const liked = entry.likedBy && entry.likedBy.includes(auth.currentUser.uid);

                        entryElement.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <p class="font-semibold text-amber-800">${entry.author}ë‹˜ì˜ ì¼ê¸°</p>
                                <span class="text-xs text-gray-500">${formattedDate}</span>
                            </div>
                            <div class="entry-content-clickable cursor-pointer">
                                <p class="text-gray-700 whitespace-pre-wrap truncate">${textPreview}</p>
                            </div>
                            <div class="flex items-center space-x-4 text-sm text-gray-500 mt-2 pt-2 border-t border-amber-100">
                                <button class="like-btn heart-btn ${liked ? 'liked' : ''} flex items-center space-x-1 hover:text-red-500">
                                    <i class="fa-solid fa-heart"></i> 
                                    <span>${entry.likes || 0}</span>
                                </button>
                                <button class="comment-btn flex items-center space-x-1 hover:text-blue-500">
                                    <i class="fa-regular fa-comment"></i>
                                    <span>ëŒ“ê¸€</span>
                                </button>
                            </div>`;
                        entriesList.appendChild(entryElement);
                    });
                }
            };

            // --- ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ ë¡œì§ ---
            const makeImageResizable = (img) => {
                document.querySelectorAll('.resizable-wrapper').forEach(wrapper => { wrapper.parentNode.insertBefore(wrapper.firstChild, wrapper); wrapper.parentNode.removeChild(wrapper); });
                const wrapper = document.createElement('span');
                wrapper.className = 'resizable-wrapper active'; wrapper.contentEditable = false;
                img.parentNode.insertBefore(wrapper, img); wrapper.appendChild(img);
                const handle = document.createElement('span');
                handle.className = 'resize-handle br'; wrapper.appendChild(handle);
                handle.addEventListener('mousedown', (e) => {
                    e.preventDefault(); e.stopPropagation();
                    const startX = e.clientX; const startWidth = img.offsetWidth;
                    const doDrag = (e) => { const newWidth = startWidth + (e.clientX - startX); if (newWidth > 50) img.style.width = newWidth + 'px'; };
                    const stopDrag = () => { document.documentElement.removeEventListener('mousemove', doDrag, false); document.documentElement.removeEventListener('mouseup', stopDrag, false); };
                    document.documentElement.addEventListener('mousemove', doDrag, false); document.documentElement.addEventListener('mouseup', stopDrag, false);
                });
            };
            
            // --- ì¢‹ì•„ìš” í•¸ë“¤ëŸ¬ ---
            const handleLikeClick = async (entryId, author) => {
                const entryRef = doc(db, "journalApp", author, "entries", entryId);
                const feedRef = doc(db, "feedEntries", entryId);
                try {
                    await runTransaction(db, async (transaction) => {
                        const entryDoc = await transaction.get(entryRef);
                        if (!entryDoc.exists()) throw "ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!";
                        const likedBy = entryDoc.data().likedBy || [];
                        const uid = auth.currentUser.uid;
                        const newLikedBy = likedBy.includes(uid) ? likedBy.filter(id => id !== uid) : [...likedBy, uid];
                        const newLikes = newLikedBy.length;
                        transaction.update(entryRef, { likes: newLikes, likedBy: newLikedBy });
                        transaction.update(feedRef, { likes: newLikes, likedBy: newLikedBy });
                    });
                } catch (error) {
                    console.error("ì¢‹ì•„ìš” ì²˜ë¦¬ ì‹¤íŒ¨: ", error);
                }
            };

            // --- ì´ëª¨í‹°ì½˜ ì„¤ì • ---
            function setupEmoticons() {
                const emoticonBar = document.getElementById('emoticon-bar');
                const emoticons = ['ğŸ˜Š', 'ğŸ¥°', 'ğŸ‘', 'ğŸ™', 'ğŸ‰', 'â˜€ï¸', 'â¤ï¸', 'ğŸ˜‚', 'ğŸ˜­', 'ğŸ˜®'];
                
                emoticonBar.innerHTML = '';
                emoticons.forEach(emo => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'text-2xl hover:scale-125 transition-transform focus:outline-none';
                    button.textContent = emo;
                    button.addEventListener('click', () => {
                        journalEntry.focus();
                        const selection = window.getSelection();
                        
                        if (savedRange) {
                            selection.removeAllRanges();
                            selection.addRange(savedRange);
                        }

                        if (selection.getRangeAt && selection.rangeCount) {
                            const range = selection.getRangeAt(0);
                            range.deleteContents();
                            const textNode = document.createTextNode(emo);
                            range.insertNode(textNode);
                            
                            const spaceNode = document.createTextNode('\u00A0');
                            range.setStartAfter(textNode);
                            range.insertNode(spaceNode);
                            range.setStartAfter(spaceNode);
                            range.collapse(true);

                            selection.removeAllRanges();
                            selection.addRange(range);
                            
                            savedRange = range;
                        }
                    });
                    emoticonBar.appendChild(button);
                });
            }


            // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
            document.addEventListener('click', (e) => {
                const target = e.target;
                if (target.tagName === 'IMG' && target.closest('.editable-div')) { makeImageResizable(target); } 
                else if (!target.closest('.resizable-wrapper')) { document.querySelectorAll('.resizable-wrapper').forEach(wrapper => { wrapper.parentNode.insertBefore(wrapper.firstChild, wrapper); wrapper.parentNode.removeChild(wrapper); }); }
            });

            journalEntry.addEventListener('blur', () => { const selection = window.getSelection(); if (selection.rangeCount > 0) savedRange = selection.getRangeAt(0); });

            journalPhoto.addEventListener('change', async (e) => {
                const file = e.target.files[0]; if (!file) return;
                const userId = auth.currentUser.uid; const filePath = `journalImages/${userId}/${Date.now()}-${file.name}`;
                const storageRef = ref(storage, filePath);
                try {
                    loadingOverlay.style.display = 'flex';
                    await uploadBytes(storageRef, file);
                    const url = await getDownloadURL(storageRef);
                    const img = document.createElement('img'); img.src = url;
                    journalEntry.focus(); const selection = window.getSelection();
                    if (savedRange) { selection.removeAllRanges(); selection.addRange(savedRange); }
                    if (selection.getRangeAt && selection.rangeCount) {
                        let range = selection.getRangeAt(0); range.deleteContents(); range.insertNode(img);
                        const space = document.createTextNode("\u00A0"); range.insertNode(space);
                        range.setStartAfter(space); range.collapse(true);
                        selection.removeAllRanges(); selection.addRange(range);
                    }
                } catch (error) { console.error("ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨:", error); } 
                finally { journalPhoto.value = ''; loadingOverlay.style.display = 'none'; }
            });

            userTabsContainer.addEventListener('click', async (e) => {
                const tab = e.target.closest('.user-tab');
                if (tab) {
                    const user = tab.dataset.user;
                    const switchView = (targetUser) => {
                        if (appState.activeView === targetUser) return;
                        appState.activeView = targetUser; 
                        localStorage.setItem('activeView', targetUser);
                        renderUI();
                    };

                    if (e.target.closest('.delete-user-btn')) {
                        const action = async () => {
                            loadingOverlay.style.display = 'flex';
                            const entriesRef = collection(db, "journalApp", user, "entries");
                            const entriesSnapshot = await getDocs(entriesRef);
                            const batch = writeBatch(db);
                            entriesSnapshot.forEach((doc) => {
                                batch.delete(doc.ref);
                                batch.delete(doc(db, "feedEntries", doc.id));
                            });
                            await batch.commit();
                            const metadataRef = doc(db, "journalApp", "metadata");
                            const newUsers = { ...appState.users }; delete newUsers[user];
                            await updateDoc(metadataRef, { users: newUsers });
                            
                            if (appState.primaryUser === user) {
                                const newPrimary = Object.keys(newUsers).length > 0 ? Object.keys(newUsers)[0] : null;
                                localStorage.setItem('primaryUser', newPrimary);
                                appState.primaryUser = newPrimary;
                            }
                            if (appState.activeView === user) {
                                const newActive = appState.primaryUser || 'feed';
                                localStorage.setItem('activeView', newActive);
                                appState.activeView = newActive;
                            }
                            loadingOverlay.style.display = 'none';
                        };
                        if (appState.users[user].password) showModal('password', { user: user, onPassword: action });
                        else showModal('confirmDelete', { message: `'${user}' ì‚¬ìš©ìì˜ ëª¨ë“  ì¼ê¸°ê°€ ì‚¬ë¼ì§‘ë‹ˆë‹¤.`, onConfirm: action });
                    } else {
                        const needsPassword = user !== 'feed' && user !== appState.primaryUser && appState.users[user].password;
                        if (needsPassword && !unlockedUsers.has(user)) {
                             showModal('password', { 
                                 user: user, 
                                 onPassword: () => {
                                     unlockedUsers.add(user);
                                     switchView(user);
                                 } 
                             });
                        } else {
                            switchView(user);
                        }
                    }
                }
                if (e.target.closest('#add-user-btn')) showModal('addUser');
            });

            journalForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const content = journalEntry.innerHTML;
                if (!content.trim() || journalEntry.textContent.trim() === '' && !journalEntry.querySelector('img')) { return; }
                loadingOverlay.style.display = 'flex';
                // ê¸€ì“°ê¸°ëŠ” í•­ìƒ primaryUserì—ê²Œ ì €ì¥
                const entriesRef = collection(db, "journalApp", appState.primaryUser, "entries");
                const newEntryData = { date: journalDate.value, content: content, createdAt: serverTimestamp(), likes: 0, likedBy: [] };
                const docRef = await addDoc(entriesRef, newEntryData);
                
                const feedRef = doc(db, "feedEntries", docRef.id);
                await setDoc(feedRef, { ...newEntryData, author: appState.primaryUser });

                const metadataRef = doc(db, "journalApp", "metadata");
                const updatedUsers = { ...appState.users };
                Object.keys(updatedUsers).forEach(user => { if (user !== appState.primaryUser) updatedUsers[user].hasNew = true; });
                await updateDoc(metadataRef, { users: updatedUsers });
                journalEntry.innerHTML = ''; 
                setToday();
                loadingOverlay.style.display = 'none';
            });

            entriesList.addEventListener('click', (e) => {
                const entryElement = e.target.closest('div[data-id]');
                if (!entryElement) return;
                const entryId = entryElement.dataset.id;
                const author = entryElement.dataset.author || appState.activeView;
                const entryData = appState.entries.find(entry => entry.id === entryId);

                const performAction = (action) => { if (appState.activeView !== 'feed' && appState.users[author].password) showModal('password', { user: author, onPassword: action }); else action(); };

                if (e.target.closest('.like-btn')) {
                    handleLikeClick(entryId, author);
                } else if (e.target.closest('.delete-btn')) {
                    performAction(async () => {
                        showModal('confirmDelete', { message: 'ì´ ì¼ê¸°ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.', onConfirm: async () => { 
                            await deleteDoc(doc(db, "journalApp", author, "entries", entryId));
                            await deleteDoc(doc(db, "feedEntries", entryId));
                        }});
                    });
                } else if (e.target.closest('.edit-btn')) {
                    performAction(() => {
                        showModal('edit', { content: entryData.content, onSave: async (newContent) => { 
                            const entryRef = doc(db, "journalApp", author, "entries", entryId);
                            await updateDoc(entryRef, { content: newContent });
                            const feedRef = doc(db, "feedEntries", entryId);
                            await updateDoc(feedRef, { content: newContent });
                        }});
                    });
                } else if (entryData && (e.target.closest('.entry-content-clickable') || e.target.closest('.comment-btn'))) {
                    const date = new Date(entryData.date);
                    const adjustedDate = new Date(date.getTime() + (date.getTimezoneOffset() * 60000));
                    const formattedDate = adjustedDate.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
                    showModal('viewEntry', { ...entryData, date: formattedDate, author: author });
                }
            });

            const displayRandomQuote = () => { quoteElement.textContent = `"${gratitudeQuotes[Math.floor(Math.random() * gratitudeQuotes.length)]}"`; };
            newQuoteBtn.addEventListener('click', displayRandomQuote);
            displayRandomQuote();

            // --- ì•± ì‹œì‘ ---
            setupEmoticons();
            initializeFirebase();
        });
    </script>
</body>
</html>

